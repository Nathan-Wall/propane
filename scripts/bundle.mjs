import * as esbuild from 'esbuild';
import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const root = path.resolve(__dirname, '..');

// Packages to bundle for NPM
const packages = [
  {
    name: 'runtime',
    entry: 'runtime/index.ts',
    external: [],
  },
  {
    name: 'pms-core',
    entry: 'pms-core/src/index.ts',
    external: [],
  },
  {
    name: 'pms-server',
    entry: 'pms-server/src/index.ts',
    external: ['ws'], // Native addon
  },
  {
    name: 'pms-client',
    entry: 'pms-client/src/index.ts',
    external: [],
  },
  {
    name: 'pms-client-compiler',
    entry: 'pms-client-compiler/src/index.ts',
    external: [],
  },
  {
    name: 'cli',
    entry: 'cli/index.ts',
    external: ['@babel/core'], // Uses babel plugin
  },
  {
    name: 'react',
    entry: 'react/index.ts',
    external: ['react'], // Peer dependency
  },
  {
    name: 'babel-messages',
    entry: 'tools/babel/messages/index.ts',
    external: ['@babel/core', '@babel/traverse', '@babel/types'],
  },
];

const distDir = path.join(root, 'dist');

// Clean dist
if (fs.existsSync(distDir)) {
  fs.rmSync(distDir, { recursive: true });
}
fs.mkdirSync(distDir, { recursive: true });

for (const pkg of packages) {
  const outdir = path.join(distDir, pkg.name);

  console.log(`Bundling ${pkg.name}...`);

  await esbuild.build({
    entryPoints: [path.join(root, pkg.entry)],
    bundle: true,
    platform: 'node',
    target: 'node18',
    format: 'esm',
    outfile: path.join(outdir, 'index.js'),
    external: pkg.external,
    sourcemap: true,
    // Resolve #* imports
    alias: {
      '#common': path.join(root, 'common'),
      '#runtime': path.join(root, 'runtime'),
      '#pms-core': path.join(root, 'pms-core'),
      '#pms-server': path.join(root, 'pms-server'),
      '#pms-client': path.join(root, 'pms-client'),
    },
  });

  // Generate .d.ts using tsc (esbuild doesn't generate types)
  // Types are already generated by the main tsc build

  // Copy package.json with updated paths
  const srcPkgPath = pkg.name === 'babel-messages'
    ? path.join(root, 'tools/babel/messages/package.json')
    : path.join(root, pkg.name, 'package.json');

  if (fs.existsSync(srcPkgPath)) {
    const pkgJson = JSON.parse(fs.readFileSync(srcPkgPath, 'utf8'));
    pkgJson.main = 'index.js';
    pkgJson.types = 'index.d.ts';
    delete pkgJson.private;
    delete pkgJson.scripts;
    delete pkgJson.devDependencies;
    fs.writeFileSync(
      path.join(outdir, 'package.json'),
      JSON.stringify(pkgJson, null, 2)
    );
  }
}

console.log('Bundling complete!');
